<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, interactive-widget=resizes-content" />
<title>Word Flow by Shafiullah</title>

<link rel="manifest" href="manifest.json">

<link rel="apple-touch-icon" href="icon.png">

<link rel="icon" href="icon.png">

<meta name="theme-color" content="#2b2f8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="My Web App">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

<style>
  :root {
    --bg: #1e1932;
    --fg: #f0f0f0;
    --muted: #a0a0a0;
    --accent: #ff4081;
    --ok: #4caf50;
    --error: #f44336;
    --gradient-start: #ff4081; /* Pink */
    --gradient-end: #ff8c00;   /* Orange */
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: var(--bg);
    color: var(--fg);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  /* top toolbar */
  #toolbar {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 100%;
    padding: 10px;
    background: #282840;
    border-bottom: 1px solid #4a4a6e;
    flex-shrink: 0;
  }
  #toolbar button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 24px;
    transition: all 0.2s ease;
  }
  #toolbar button i {
    background-image: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  #toolbar button:active {
    transform: scale(0.9);
  }
  #status {
    font-size: 14px;
    color: var(--muted);
    margin: 6px 0;
    text-align: center;
    padding: 0 10px;
  }
  /* big word area with nav buttons */
  #wordBox {
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  #wordDisplay {
    font-size: 30px;
    font-weight: bold;
    text-align: center;
    white-space: pre-wrap;
    overflow-y: auto;
    color: var(--fg);
  }
  #wordDisplay span.correct {
    color: var(--ok);
  }
  #wordDisplay span.wrong {
    color: var(--error);
  }
  /* navigation buttons around the word */
  .nav-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 40px; /* Larger size to match the word */
    transition: all 0.2s ease;
    padding: 0 15px;
  }
  .nav-btn i {
    background-image: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .nav-btn:active {
    transform: scale(0.9);
  }
  /* typing dock */
  #dock {
    display: flex;
    padding: 10px;
    background: #282840;
    width: 100%;
    border-top: 1px solid #4a4a6e;
    flex-shrink: 0;
    align-items: center;
  }
  #typeInput {
    flex: 1;
    padding: 12px 20px;
    font-size: 18px;
    border-radius: 25px; /* Modern rounded corners */
    border: none;
    outline: none;
    background: #3a3a5a;
    color: var(--fg);
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    transition: background-color 0.2s ease, box-shadow 0.2s ease;
  }
  #typeInput:focus {
    background: #4a4a6e;
    /* Static gradient glow effect */
    box-shadow: inset 0 0 8px 4px rgba(255, 64, 129, 0.7), 
                inset 0 0 12px 6px rgba(255, 140, 0, 0.5);
  }
  
  /* Shaking/Vibrating Effect CSS */
  @keyframes shake {
    10%, 90% { transform: translateX(-1px); }
    20%, 80% { transform: translateX(2px); }
    30%, 50%, 70% { transform: translateX(-4px); }
    40%, 60% { transform: translateX(4px); }
  }

  .shake {
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    transform: translate3d(0, 0, 0);
    backface-visibility: hidden;
    perspective: 1000px;
  }
  
  /* paste modal */
  #pasteModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
  }
  #pasteBox {
    background: #282840;
    padding: 25px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
  }
  #pasteText {
    width: 100%;
    min-height: 180px;
    border-radius: 10px;
    background: #3a3a5a;
    color: var(--fg);
    border: 1px solid #4a4a6e;
    padding: 15px;
    font-size: 16px;
    resize: vertical;
  }
  #pasteBox button {
    background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
    border: none;
    color: #fff;
    padding: 12px;
    font-size: 18px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
  }
  #pasteBox button:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }
  #pasteBox button:active {
    opacity: 0.8;
    transform: translateY(0);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
  }
  /* New CSS for camera view */
  #cameraView {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: var(--bg);
    z-index: 90;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: opacity 0.3s ease;
    opacity: 0;
  }
  #cameraView.active {
    display: flex;
    opacity: 1;
  }
  #cameraView video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  canvas { display: none; }

  #cameraControls {
    position: fixed; /* Changed to fixed position */
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    align-items: center;
    z-index: 91; /* Ensure controls are above the video */
  }
  #takePhotoBtn, #flashBtn {
    background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
    border: none;
    color: #fff;
    padding: 15px; /* Adjust padding for icon */
    font-size: 24px;
    border-radius: 50px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
    width: 60px; /* Set a fixed size for the circular button */
    height: 60px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #flashBtn {
    background: none;
    border: 2px solid var(--fg);
    color: var(--fg);
    font-size: 24px;
    padding: 10px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
  }
</style>
</head>
<body>

<div id="toolbar">
  <button id="btnCamera" title="Enable Camera"><i class="fa-solid fa-camera"></i></button>
  <button id="btnUploadImage" title="Upload Image"><i class="fa-solid fa-image"></i></button>
  <button id="btnPaste" title="Paste Text"><i class="fa-solid fa-clipboard"></i></button>
  <button id="btnShuffle" title="Shuffle Words"><i class="fa-solid fa-shuffle"></i></button>
  <button id="btnSpeech" title="Toggle Speech"><i class="fa-solid fa-volume-high"></i></button>
  <button id="btnMode" title="Toggle Mode"><i class="fa-solid fa-spell-check"></i></button>
  <button id="btnClear" title="Clear"><i class="fa-solid fa-trash"></i></button>
</div>

<div id="status"></div>
<div id="wordBox">
  <button id="btnPrev" class="nav-btn"><i class="fa-solid fa-chevron-left"></i></button>
  <div id="wordDisplay"></div>
  <button id="btnNext" class="nav-btn"><i class="fa-solid fa-chevron-right"></i></button>
</div>

<div id="dock">
  <input id="typeInput" placeholder="Type here…" autocomplete="off" spellcheck="false">
</div>

<div id="pasteModal">
  <div id="pasteBox">
    <textarea id="pasteText" placeholder="Paste or type text here…"></textarea>
    <button id="btnUsePasted">Use Text</button>
  </div>
</div>

<div id="cameraView">
  <video id="video" autoplay playsinline></video>
  <div id="cameraControls">
      <button id="takePhotoBtn"><i class="fa-solid fa-camera"></i></button>
      <button id="flashBtn" title="Toggle Flash"><i class="fa-solid fa-bolt"></i></button>
  </div>
</div>
<canvas id="canvas"></canvas>
<input type="file" id="fileInput" accept="image/*" style="display: none;">

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const wordDisplay = document.getElementById('wordDisplay');
const input = document.getElementById('typeInput');
const statusBox = document.getElementById('status');
const pasteModal = document.getElementById('pasteModal');
const cameraView = document.getElementById('cameraView');
const takePhotoBtn = document.getElementById('takePhotoBtn');
const flashBtn = document.getElementById('flashBtn');
const fileInput = document.getElementById('fileInput');
const btnSpeech = document.getElementById('btnSpeech');
const btnMode = document.getElementById('btnMode');

const btnCamera = document.getElementById('btnCamera');
const btnUploadImage = document.getElementById('btnUploadImage');
const btnShuffle = document.getElementById('btnShuffle');
const btnPaste = document.getElementById('btnPaste');
const btnClear = document.getElementById('btnClear');
const btnPrev = document.getElementById('btnPrev');
const btnNext = document.getElementById('btnNext');

let words = [];
let index = 0;
let stream = null;
let flashEnabled = false;
let isSpeechEnabled = true;
let isLetterByLetter = false;

// Speech synthesis setup
const synth = window.speechSynthesis;
const utterThis = new SpeechSynthesisUtterance();
utterThis.lang = 'en-GB'; // Changed from 'en-US' to 'en-GB'

function speak(text, delay = 0) {
  if (!isSpeechEnabled) return;
  if (synth.speaking) {
    synth.cancel();
  }
  
  if (delay > 0) {
    setTimeout(() => {
      utterThis.text = text;
      synth.speak(utterThis);
    }, delay);
  } else {
    utterThis.text = text;
    synth.speak(utterThis);
  }
}

function saveState() {
  localStorage.setItem('words', JSON.stringify(words));
  localStorage.setItem('index', index);
  localStorage.setItem('isSpeechEnabled', isSpeechEnabled);
  localStorage.setItem('isLetterByLetter', isLetterByLetter);
}

function loadState() {
  const savedWords = localStorage.getItem('words');
  const savedIndex = localStorage.getItem('index');
  const savedSpeechState = localStorage.getItem('isSpeechEnabled');
  const savedLetterByLetterState = localStorage.getItem('isLetterByLetter');
  
  if (savedWords) {
    words = JSON.parse(savedWords);
  }
  if (savedIndex) {
    index = parseInt(savedIndex, 10);
  }
  if (savedSpeechState !== null) {
    isSpeechEnabled = savedSpeechState === 'true';
    updateSpeechButtonIcon();
  }
  if (savedLetterByLetterState !== null) {
    isLetterByLetter = savedLetterByLetterState === 'true';
    updateModeButtonIcon();
  }
}

function updateSpeechButtonIcon() {
  const icon = btnSpeech.querySelector('i');
  if (isSpeechEnabled) {
    icon.classList.remove('fa-volume-xmark');
    icon.classList.add('fa-volume-high');
  } else {
    icon.classList.remove('fa-volume-high');
    icon.classList.add('fa-volume-xmark');
  }
}

function updateModeButtonIcon() {
  const icon = btnMode.querySelector('i');
  if (isLetterByLetter) {
    icon.classList.remove('fa-font');
    icon.classList.add('fa-spell-check');
  } else {
    icon.classList.remove('fa-spell-check');
    icon.classList.add('fa-font');
  }
  statusBox.textContent = `Mode is now: ${isLetterByLetter ? 'Letter-by-Letter' : 'Whole Word'}`;
}

// Toggle speech functionality
btnSpeech.onclick = () => {
  isSpeechEnabled = !isSpeechEnabled;
  updateSpeechButtonIcon();
  saveState();
  if (synth.speaking) {
    synth.cancel();
  }
  statusBox.textContent = `Text-to-speech is now ${isSpeechEnabled ? 'on' : 'off'}.`;
};

// Toggle mode functionality
btnMode.onclick = () => {
  isLetterByLetter = !isLetterByLetter;
  updateModeButtonIcon();
  saveState();
};

function updateStatus() {
  if (words.length > 0) {
    statusBox.textContent = `Word ${index + 1} of ${words.length}`;
  } else {
    statusBox.textContent = "No words loaded.";
  }
}

function showWord() {
  if (!words.length) {
    wordDisplay.textContent = "Please scan or paste text.";
    return;
  }
  wordDisplay.textContent = words[index];
  updateStatus();
}

function nextWord() {
  index = (index + 1) % words.length;
  showWord();
  input.value = "";
  saveState();
}

function prevWord() {
  index = (index - 1 + words.length) % words.length;
  showWord();
  input.value = "";
  saveState();
}

// Function to perform OCR from a given image source
async function performOCR(imageSource) {
  statusBox.textContent = "Scanning text...";
  try {
    const { data: { text } } = await Tesseract.recognize(imageSource, 'eng');
    const cleanText = text.replace(/[^a-zA-Z\s]/g, '').trim();
    words = cleanText.split(/\s+/).filter(w => w.length > 2);
    index = 0;
    if (words.length) {
      statusBox.textContent = `Found ${words.length} words.`;
      showWord();
      saveState();
    } else {
      statusBox.textContent = "No words were detected. Please try again.";
    }
  } catch (error) {
    console.error(error);
    statusBox.textContent = "Text recognition failed. Please try again.";
  }
}

input.addEventListener("input", (e) => {
  if (!words.length) return;
  const target = words[index];
  const typed = input.value;
  
  // Speak single letter if in letter-by-letter mode
  if (isSpeechEnabled && isLetterByLetter && e.data) {
    speak(e.data);
  }

  const targetLower = target.toLowerCase();
  const typedLower = typed.toLowerCase();

  let html = "";
  let wrongLetterFound = false;

  for (let i = 0; i < target.length; i++) {
    if (typedLower[i] == null) {
      html += `<span>${target[i]}</span>`;
    } else if (typedLower[i] === targetLower[i]) {
      html += `<span class="correct">${target[i]}</span>`;
    } else {
      html += `<span class="wrong">${target[i]}</span>`;
      wrongLetterFound = true;
    }
  }
  wordDisplay.innerHTML = html;

  if (wrongLetterFound) {
    input.classList.add('shake');
  } else {
    input.classList.remove('shake');
  }

  if (typedLower === targetLower) {
  if (isLetterByLetter) {
  // Speak the last letter first
  speak(target[target.length - 1]);
  
  // Dynamic delay: 300ms + 50ms per letter
  const delay = 300 + target.length * 50;
  
  // Then speak the whole word
  setTimeout(() => speak(target), delay);
} else {
  speak(target);
}
  input.value = "";
  nextWord();
  }
});

input.addEventListener('animationend', () => {
    input.classList.remove('shake');
});

// Navigation button handlers
btnPrev.onclick = prevWord;
btnNext.onclick = nextWord;

// Enable camera
btnCamera.onclick = async () => {
  try {
    const constraints = { video: { facingMode: "environment" } };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
    cameraView.classList.add('active'); // Show camera view
    statusBox.textContent = "Aim camera at text and tap 'Take Photo'.";
  } catch {
    statusBox.textContent = "Camera access denied or unsupported. Switch to HTTPS.";
  }
};

// Toggle flash
flashBtn.onclick = async () => {
  if (!stream) {
    statusBox.textContent = "Camera not enabled.";
    return;
  }
  const track = stream.getVideoTracks()[0];
  if (track) {
    try {
      const capabilities = track.getCapabilities();
      if (capabilities.torch) {
        flashEnabled = !flashEnabled;
        await track.applyConstraints({
          advanced: [{ torch: flashEnabled }]
        });
        flashBtn.style.backgroundColor = flashEnabled ? 'var(--accent)' : 'none';
        flashBtn.style.color = flashEnabled ? '#fff' : 'var(--fg)';
        statusBox.textContent = flashEnabled ? "Flashlight on." : "Flashlight off.";
      } else {
        statusBox.textContent = "Flashlight not supported.";
      }
    } catch (err) {
      statusBox.textContent = "Failed to toggle flashlight.";
    }
  }
};

// Take a photo and scan text
takePhotoBtn.onclick = async () => {
  if (!stream) {
    statusBox.textContent = "Please enable the camera first.";
    return;
  }
  
  // Set canvas dimensions to match video stream
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  
  // Draw the last video frame to the canvas
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  
  // Stop the video stream and release the camera
  stream.getTracks().forEach(track => track.stop());
  video.srcObject = null;
  stream = null;
  
  cameraView.classList.remove('active'); // Hide camera view after scanning
  
  performOCR(canvas);
};

// Upload image button
btnUploadImage.onclick = () => {
  fileInput.click();
};

// Handle file input change
fileInput.onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (event) => {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      performOCR(canvas);
    };
    img.src = event.target.result;
  };
  reader.readAsDataURL(file);
};

// Shuffle
btnShuffle.onclick = () => {
  if (!words.length) {
    statusBox.textContent = "No words to shuffle. Please load words first.";
    return;
  }
  for (let i = words.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [words[i], words[j]] = [words[j], words[i]];
  }
  index = 0;
  showWord();
  saveState();
  statusBox.textContent = "Words have been shuffled.";
};

// Paste text (open modal)
btnPaste.onclick = () => {
  document.getElementById("pasteText").value = "";
  pasteModal.style.display = "flex";
};

// Use pasted text
document.getElementById("btnUsePasted").onclick = () => {
  const text = document.getElementById("pasteText").value;
  const cleanText = text.replace(/[^a-zA-Z\s]/g, '').trim();
  words = cleanText.split(/\s+/).filter(w => w.length > 2);
  index = 0;
  showWord();
  pasteModal.style.display = "none";
  saveState();
  updateStatus();
};

// Close modal when clicking outside
pasteModal.onclick = (e) => {
  if (e.target === pasteModal) {
    pasteModal.style.display = "none";
  }
};

// Clear
btnClear.onclick = () => {
  words = [];
  index = 0;
  localStorage.removeItem('words');
  localStorage.removeItem('index');
  showWord();
  statusBox.textContent = "All words have been cleared.";
  cameraView.classList.remove('active');
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    stream = null;
  }
};

// Initial state
loadState();
showWord();
if (words.length > 0) {
  updateStatus();
} else {
  statusBox.textContent = "Ready. Scan or paste text to begin.";
}
</script>
</body>
</html>
